@startuml
hide footbox

' ★色設定
skinparam boundary {
  BackgroundColor #D5E8D4
}
skinparam entity {
  BackgroundColor #DAE8FC
}
skinparam control {
  BackgroundColor #F8CECC
}

' オブジェクト定義
actor User as U
boundary "ProductDetail.jsp" as DetailScreen
control "CartController.java" as CartControl
boundary "MessageDisplay.jsp" as MsgScreen
entity "ProductDB.java" as PDB
entity "CartDB.java" as CDB

title Cart Addition Flow (Class Diagram Aligned)

U -> DetailScreen : 1. 数量を選択
activate DetailScreen

U -> DetailScreen : 2. 「カートに追加」ボタンをクリック

' クラス図にないため日本語のまま
DetailScreen -> CartControl : カート追加要求(productId, quantity)
activate CartControl

' クラス図にないため日本語のまま
CartControl -> PDB : 在庫と価格を照会()
activate PDB
PDB --> CartControl : 在庫数と最新価格
deactivate PDB

alt 在庫不足の場合 (代替フロー 3a)
    ' クラス図にないため日本語のまま
    CartControl -> MsgScreen : エラーメッセージを表示("カートに追加できませんでした")
    activate MsgScreen
    MsgScreen --> CartControl : 表示完了通知
    deactivate MsgScreen
    CartControl --> DetailScreen : エラーレスポンス
    deactivate CartControl
    DetailScreen -> U : メッセージ表示

else 在庫が適切で価格に問題がない場合
    ' クラス図にないため日本語のまま
    CartControl -> CDB : ユーザーの既存カートを照会()
    activate CDB
    CDB --> CartControl : 既存カート情報 または null
    deactivate CDB

    alt 既存のカート情報が存在しない場合 (新規作成)
        ' クラス図にないため日本語のまま
        CartControl -> CDB : 新しいカートを作成(商品情報, 数量)
        activate CDB
        CDB --> CartControl : 更新後のカート情報
        deactivate CDB
    else 既存のカート情報が存在する場合 (代替フロー 4a: 更新)
        ' クラス図にないため日本語のまま
        CartControl -> CDB : カート情報を更新(商品ID, 数量)
        activate CDB
        CDB --> CartControl : 更新後のカート情報
        deactivate CDB
    end
    
    ' クラス図にないため日本語のまま
    CartControl --> DetailScreen : 成功レスポンス(カート情報)
    deactivate CartControl
    DetailScreen -> U : 成功メッセージとカート内容一覧を表示
end

deactivate DetailScreen

@enduml
